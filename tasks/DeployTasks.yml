version: '3.41.0'

includes:
  installTasks: ./InstallTasks.yml

tasks:
  apply-all-manifests:
    aliases:
      - all-manifests
    deps:
      - :create-cluster
    cmds:
      - kubectl apply -f manifests/*
    requires:
      vars:
        - CLUSTER_NAME
    preconditions:
      - test -d manifests

  add-argo-helm-repo:
    internal: true
    aliases:
      - argo-helm
    deps:
      - :create-cluster
      - installTasks:helm
    cmds:
      - helm repo add argo https://argoproj.github.io/argo-helm
    status:
      - helm repo list | grep -i argo

  argo-workflows:
    aliases:
      - workflows
    deps:
      - :create-cluster
      - installTasks:helm
      - add-argo-helm-repo
    cmds:
      - helm upgrade -i $ARGO_WORKFLOWS_RELEASE_NAME argo/argo-workflows
    requires:
      vars:
        - ARGO_WORKFLOWS_RELEASE_NAME
    preconditions:
      - test -d values
      - test -f values/argo-workflows-values.yaml

  argo-events:
    aliases:
      - events
    deps:
      - :create-cluster
      - installTasks:helm
      - add-argo-helm-repo
    cmds:
      - helm upgrade -i $ARGO_EVENTS_RELEASE_NAME argo/argo-events
    requires:
      vars:
        - ARGO_EVENTS_RELEASE_NAME
    preconditions:
      - test -d values
      - test -f values/argo-events-values.yaml